{{- if .Values.grafana.enabled }}
{{- $root := . }}
{{- range $path, $_ := .Files.Glob "dashboards/*.json" }}
{{- $name := $path | base | trimSuffix ".json" }}

{{- /* Check mixin enablement and folder based on dashboard name */}}
{{- $enabled := true }}
{{- $folder := "" }}
{{- if hasPrefix "argo-cd-" $name }}
  {{- $enabled = $root.Values.mixins.argocd.enabled }}
  {{- $folder = $root.Values.grafana.folders.argocd }}
{{- else if eq $name "nodes" }}
  {{- /* Linux nodes dashboard */}}
  {{- $enabled = and $root.Values.mixins.nodeExporter.enabled $root.Values.mixins.nodeExporter.platforms.linux }}
  {{- $folder = $root.Values.grafana.folders.nodeExporter }}
{{- else if eq $name "nodes-darwin" }}
  {{- /* Darwin/macOS nodes dashboard */}}
  {{- $enabled = and $root.Values.mixins.nodeExporter.enabled $root.Values.mixins.nodeExporter.platforms.darwin }}
  {{- $folder = $root.Values.grafana.folders.nodeExporter }}
{{- else if eq $name "nodes-aix" }}
  {{- /* AIX nodes dashboard */}}
  {{- $enabled = and $root.Values.mixins.nodeExporter.enabled $root.Values.mixins.nodeExporter.platforms.aix }}
  {{- $folder = $root.Values.grafana.folders.nodeExporter }}
{{- else if hasPrefix "node-" $name }}
  {{- /* USE Method dashboards (platform-agnostic) */}}
  {{- $enabled = $root.Values.mixins.nodeExporter.enabled }}
  {{- $folder = $root.Values.grafana.folders.nodeExporter }}
{{- else if eq $name "pod-optimization" }}
  {{- $enabled = $root.Values.mixins.resourceOptimization.enabled }}
  {{- $folder = $root.Values.grafana.folders.resourceOptimization }}
{{- else if contains "windows" $name }}
  {{- /* Windows dashboards (part of kubernetes-mixin) */}}
  {{- $enabled = and $root.Values.mixins.kubernetes.enabled $root.Values.mixins.kubernetes.windows.enabled }}
  {{- $folder = $root.Values.grafana.folders.kubernetes }}
{{- else if hasPrefix "loki-" $name }}
  {{- $enabled = $root.Values.mixins.loki.enabled }}
  {{- $folder = $root.Values.grafana.folders.loki }}
{{- else }}
  {{- $enabled = $root.Values.mixins.kubernetes.enabled }}
  {{- $folder = $root.Values.grafana.folders.kubernetes }}
{{- end }}

{{- if $enabled }}
---
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaDashboard
metadata:
  name: {{ $name }}
  namespace: {{ $root.Values.grafana.namespace }}
  labels:
    {{- include "gitops-mixin.labels" $root | nindent 4 }}
spec:
  folder: {{ $folder }}
  instanceSelector:
    {{- toYaml $root.Values.grafana.instanceSelector | nindent 4 }}
  json: |
    {{- $root.Files.Get $path | nindent 4 }}
{{- end }}
{{- end }}
{{- end }}
