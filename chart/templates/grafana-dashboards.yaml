{{- $root := . }}
{{- range $path, $_ := .Files.Glob "dashboards/*.json" }}
{{- $name := $path | base | trimSuffix ".json" }}

{{- /* Check mixin enablement and config based on dashboard name */}}
{{- $enabled := false }}
{{- $mixin := dict }}
{{- if hasPrefix "argo-cd-" $name }}
  {{- $enabled = $root.Values.mixins.argocd.enabled }}
  {{- $mixin = $root.Values.mixins.argocd }}
{{- else if eq $name "nodes" }}
  {{- /* Linux nodes dashboard */}}
  {{- $enabled = and $root.Values.mixins.nodeExporter.enabled $root.Values.mixins.nodeExporter.platforms.linux }}
  {{- $mixin = $root.Values.mixins.nodeExporter }}
{{- else if eq $name "nodes-darwin" }}
  {{- /* Darwin/macOS nodes dashboard */}}
  {{- $enabled = and $root.Values.mixins.nodeExporter.enabled $root.Values.mixins.nodeExporter.platforms.darwin }}
  {{- $mixin = $root.Values.mixins.nodeExporter }}
{{- else if eq $name "nodes-aix" }}
  {{- /* AIX nodes dashboard */}}
  {{- $enabled = and $root.Values.mixins.nodeExporter.enabled $root.Values.mixins.nodeExporter.platforms.aix }}
  {{- $mixin = $root.Values.mixins.nodeExporter }}
{{- else if hasPrefix "node-" $name }}
  {{- /* USE Method dashboards (platform-agnostic) */}}
  {{- $enabled = $root.Values.mixins.nodeExporter.enabled }}
  {{- $mixin = $root.Values.mixins.nodeExporter }}
{{- else if eq $name "pod-optimization" }}
  {{- $enabled = $root.Values.mixins.resourceOptimization.enabled }}
  {{- $mixin = $root.Values.mixins.resourceOptimization }}
{{- else if contains "windows" $name }}
  {{- /* Windows dashboards (part of kubernetes-mixin) */}}
  {{- $enabled = and $root.Values.mixins.kubernetes.enabled $root.Values.mixins.kubernetes.windows.enabled }}
  {{- $mixin = $root.Values.mixins.kubernetes }}
{{- else if hasPrefix "loki-" $name }}
  {{- $enabled = $root.Values.mixins.loki.enabled }}
  {{- $mixin = $root.Values.mixins.loki }}
{{- else if hasPrefix "alloy-" $name }}
  {{- $enabled = $root.Values.mixins.alloy.enabled }}
  {{- $mixin = $root.Values.mixins.alloy }}
{{- else if hasPrefix "mimir-" $name }}
  {{- $enabled = $root.Values.mixins.mimir.enabled }}
  {{- $mixin = $root.Values.mixins.mimir }}
{{- else if hasPrefix "tempo-" $name }}
  {{- $enabled = $root.Values.mixins.tempo.enabled }}
  {{- $mixin = $root.Values.mixins.tempo }}
{{- else }}
  {{- /* Default to kubernetes mixin */}}
  {{- $enabled = $root.Values.mixins.kubernetes.enabled }}
  {{- $mixin = $root.Values.mixins.kubernetes }}
{{- end }}

{{- if $enabled }}
---
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaDashboard
metadata:
  name: {{ $name }}
  namespace: {{ $mixin.namespace }}
  labels:
    {{- include "gitops-mixin.labels" $root | nindent 4 }}
spec:
  folder: {{ $mixin.dashboards.folder }}
  {{- with $mixin.dashboards.instanceSelector }}
  instanceSelector:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  json: |
    {{- $root.Files.Get $path | nindent 4 }}
{{- end }}
{{- end }}
